<!DOCTYPE HTML>
<html>
<head>

	<style>
		html, body{
			margin: 0;
			padding: 0;

			color: #999;
			background-color: #111;
		}

		#W {
			width: 900px;
			height: 900px;

			margin: 20px auto;
			position: relative;

			border: 1px dashed #999;

			overflow: hidden;
		}

		.box {
			width: 20px;
			height: 20px;
			border: 1px solid #999;

			position: absolute;
		}
	</style>

	<script language = "javascript" src = "numeric.js"></script>
	<script src = "https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>

	<script language = "javascript">

		var E = {
			w: function(){ return $('#W').width(); },
			h: function(){ return $('#W').height(); },
			offsetX: function(){ return $('#W').offset().left },
			offsetY: function(){ return $('#W').offset().top }
		};
		function globalq(q){ return ([q[0]-E.offsetX(), E.w()-q[1]+E.offsetY()]); }



		var dt = 0.1;
		var g = [0, -9.8, 0];



		var box = function(i, m, w, h, q, v){
			this.i = i; //index

			this.invm = 1/m;
			this.invI = 12/(m*(h*h+w*w));

			this.w = w;	//width
			this.h = h;	//height

			this.q = q; //position
			this.qprev = numeric['-'](q, numeric['*'](v, dt)); //prev position

			this.render(); this.sync();
		}

		box.prototype.render = function(){

			S = '<div id = "B' + this.i + '" class = "box" style = "' +
			'width:' + this.w + 'px; height:' + this.h + 'px;' +
			'left:' + (-this.w/2) + 'px;' +
			'bottom:' + (-this.h/2) + 'px;' +
			'"></div>';

			$('#W').append(S); this.elem = $('#B' + this.i);
		}

		box.prototype.sync = function(){
			this.elem.css({
				'-webkit-transform' : 'translate('
				+ this.q[0] + 'px, '
				+ (-this.q[1]) + 'px) rotate('
				+ (-this.q[2]) + 'rad)'
			});
		}



		//constraint general
		var constraint = function(i, S){
			this.i = i;	//index
			this.S = S; //member bodies

			this.W = [];

			for(var i = 0; i < 3*this.S.length; ++i){ this.W[i] = [];
			for(var j = 0; j < 3*this.S.length; ++j){
				this.W[i][j] = 0;
			}}

			for(var i = 0; i < S.length; ++i){
				this.W[3*i][3*i] = S[i].invm;
				this.W[3*i+1][3*i+1] = S[i].invm;
				this.W[3*i+2][3*i+2] = S[i].invI;
			}

		}
		constraint.prototype.condition = function(){ return true; }
		constraint.prototype.C = function() { return 0;	}
		constraint.prototype.nablaC = function() {

			var nablaC = [];

			var C0 = this.C();
			var epsilon = 1e-6;
			for(var i = 0; i < this.S.length; ++i){
				this.S[i].q[0] += epsilon; nablaC[3*i] = (this.C()-C0)/epsilon; this.S[i].q[0] -= epsilon;
				this.S[i].q[1] += epsilon; nablaC[3*i+1] = (this.C()-C0)/epsilon; this.S[i].q[1] -= epsilon;
				this.S[i].q[2] += epsilon; nablaC[3*i+2] = (this.C()-C0)/epsilon; this.S[i].q[2] -= epsilon;
			}

			return [nablaC];
		}
		constraint.prototype.solve = function(){

			if(this.condition()){
				var nablaC = this.nablaC();
				var nablaCT = numeric['transpose'](nablaC);

				var WnablaCT = numeric['dot'](this.W, nablaCT);

				var nablaCWnablaCT =
				numeric['dot'](nablaC, WnablaCT);

				if(numeric['det'](nablaCWnablaCT) == 0){ return; }

				var lambda =
				numeric['*'](
					numeric['inv'](nablaCWnablaCT), numeric['*'](-1, this.C())
				);

				var dP = numeric['dot'](WnablaCT, lambda);
				//update positions
				for(var i = 0; i < this.S.length; ++i){
					this.S[i].q = numeric['+'](this.S[i].q, [dP[3*i][0], dP[3*i+1][0], dP[3*i+2][0]]);
				}
			}
		}




		function rot(th, v){
		return ([v[0]*Math.cos(th) + v[1]*Math.sin(th),	v[0]*Math.sin(th) - v[1]*Math.cos(th)]);
		}

		//constraint: rev constraint
		function rev_constraint(i, A, B, P){
			constraint.call(this, i, [A, B]);

			this.rA = numeric['-'](P, [this.S[0].q[0], this.S[0].q[1]]);
			this.rA = rot(-this.S[0].q[2], this.rA);

			this.rB = numeric['-'](P, [this.S[1].q[0], this.S[1].q[1]]);
			this.rB = rot(-this.S[1].q[2], this.rB);
		}
		rev_constraint.prototype = Object.create(constraint.prototype);
		rev_constraint.prototype.constructor = rev_constraint;

		rev_constraint.prototype.C = function(){
			var D = numeric['-'](
				numeric['+'](
					[this.S[0].q[0], this.S[0].q[1]],
					rot(this.S[0].q[2], this.rA)
				),
				numeric['+'](
					[this.S[1].q[0], this.S[1].q[1]],
					rot(this.S[1].q[2], this.rB)
				)
			);
			//console.log(D);
			return numeric['dot'](D, D);
		}



		//constraint: anchor constraint
		function anchor_constraint(i, A){
			constraint.call(this, i, [A]);

			this.P = this.S[0].q;
		}
		anchor_constraint.prototype = Object.create(constraint.prototype);
		anchor_constraint.prototype.constructor = anchor_constraint;

		anchor_constraint.prototype.C = function(){
			var D = numeric['-'](this.S[0].q, this.P);
			return numeric['dot'](D, D);
		}







		var B = []; var blabel = 0; //all bodies
		var C = []; var clabel = 0; //static constraints
	
		function demo_hinges(){

			var Blab0 = blabel;

			B[blabel] = new box(blabel, 1, 130, 10, [300, 300, 0], [10, 0, 0]); ++blabel;
			B[blabel] = new box(blabel, 1, 10, 130, [360, 360, 0], [0, 0, 0]); ++blabel;
			B[blabel] = new box(blabel, 1, 130, 10, [300, 420, 0], [0, 0, 0]); ++blabel;
			B[blabel] = new box(blabel, 1, 10, 130, [240, 360, 0], [0, 0, 0]); ++blabel;


			C[clabel] = new anchor_constraint(clabel, B[Blab0+2]); ++clabel;

			C[clabel] = new rev_constraint(clabel, B[Blab0+0], B[Blab0+1], [360, 300]); ++clabel;
			C[clabel] = new rev_constraint(clabel, B[Blab0+1], B[Blab0+2], [360, 420]); ++clabel;
			C[clabel] = new rev_constraint(clabel, B[Blab0+2], B[Blab0+3], [240, 420]); ++clabel;
			C[clabel] = new rev_constraint(clabel, B[Blab0+3], B[Blab0+0], [240, 300]); ++clabel;
		}

		function demo_chain(){
			var Blab0 = blabel;

			B[blabel] = new box(blabel, 1, 10, 70, [600, 600, 0], [0, 0, 0]); ++blabel;
			B[blabel] = new box(blabel, 1, 10, 70, [600, 540, 0], [0, 0, 0]); ++blabel;
			B[blabel] = new box(blabel, 1, 10, 70, [600, 480, 0], [0, 0, 0]); ++blabel;
			B[blabel] = new box(blabel, 1, 10, 70, [600, 420, 0], [0, 0, 0]); ++blabel;
			B[blabel] = new box(blabel, 1, 10, 70, [600, 360, 0], [200, 0, 0]); ++blabel;

			C[clabel] = new anchor_constraint(clabel, B[Blab0+0]); ++clabel;

			C[clabel] = new rev_constraint(clabel, B[Blab0+0], B[Blab0+1], [600, 570]); ++clabel;
			C[clabel] = new rev_constraint(clabel, B[Blab0+1], B[Blab0+2], [600, 510]); ++clabel;
			C[clabel] = new rev_constraint(clabel, B[Blab0+2], B[Blab0+3], [600, 450]); ++clabel;
			C[clabel] = new rev_constraint(clabel, B[Blab0+3], B[Blab0+4], [600, 390]); ++clabel;
		}

		$(document).ready(function(){

			//$(document).click(function(e){ console.log(globalq([e.pageX, e.pageY])); }); //positioncheck
			demo_chain();
			

			window.setInterval(timestep);

		});


		function integrate(){
			B.forEach(function(b){
				//verlet step
				var a = g;
				qnext = numeric['+'](numeric['-'](numeric['*'](2, b.q), b.qprev), numeric['*'](dt*dt, a));
				b.qprev = b.q; b.q = qnext;
			});
		}

		function constrain(){

			for(var i = 0; i < 12; ++i){

			C.forEach(function(c){ c.solve(); });

			}
		}

		function render(){ B.forEach(function(b){ b.sync(); }); }

		function timestep(){
			integrate();

			constrain();

			render();
		}
	</script>
</head>

<body>
	<div id = "W">

	</div>


</body>

</html>
